# BloomBeasts - Meta Horizon Deployment

This folder contains the Meta Horizon Worlds deployment of BloomBeasts.

## Overview

BloomBeasts runs in Meta Horizon Worlds with full **multiplayer support** - each player has their own persistent save data that survives across sessions. The game uses Meta Horizon's Custom UI and player storage APIs.

## Files

- **`src/BloomBeasts-GamePlatform.ts`** (7 KB) - Platform adapter
  - `HorizonPlatform` class implementing `PlatformCallbacks`
  - Handles asset loading, audio, storage, and input
  - Multiplayer persistent storage via `world.persistentStorage`
- **`src/BloomBeasts-Game.ts`** (35 KB) - UI Component
  - `BloomBeastsUI` class extending `UIComponent`
  - 109 asset Props (99 images + 10 audio)
  - All screen rendering and UI logic
- **`deploy.js`** - Deployment script that copies all files to Meta Horizon
- **Reference: `../../dist/BloomBeasts-GameEngine-Standalone.ts`** (470 KB) - Game engine bundle (generated by build)

## Features

### ✅ Multiplayer Support
- **Per-player persistent storage** using Meta Horizon's `Player.store` API
- Each player's progress, deck, and unlocked cards are saved separately
- Data persists across sessions and world visits
- Automatic save/load on game start

### ✅ Complete Asset System
- **109 Props** (99 images + 10 audio files)
- All card artwork, UI elements, and sound effects
- Visual parity with the web version
- Asset flattening build script for easy upload

### ✅ Audio System
- Background music (menu and battle)
- Sound effects (attack, card play, trap activation, etc.)
- Volume controls for music and SFX
- Dynamic audio switching based on game state

### ✅ Full Game Logic
- All game screens (start menu, missions, cards, battle, settings)
- Complete card collection and deck building
- 17 missions with AI opponents
- Combat system with abilities and effects
- XP and leveling system

## Deployment

### Quick Deploy

```bash
npm run deploy
```

This will:
1. Build the standalone game engine bundle
2. Copy both `BloomBeasts-GameEngine-Standalone.ts` and `BloomBeasts-Game.ts` to your Meta Horizon scripts folder

### Manual Deployment

If you need to deploy manually:

1. Build the bundle:
   ```bash
   npm run build
   ```

2. Copy these files to your Meta Horizon scripts folder:
   - `dist/BloomBeasts-GameEngine-Standalone.ts`
   - `deployments/horizon/src/BloomBeasts-Game.ts`

   Default location: `%LOCALAPPDATA%\..\LocalLow\Meta\Horizon Worlds\<WORLD_ID>\scripts\`

### Updating World ID

If deploying to a different Meta Horizon world, update the world ID in `deploy.js`:

```javascript
const HORIZON_SCRIPTS_PATH = path.join(
  process.env.LOCALAPPDATA || process.env.APPDATA,
  '../LocalLow/Meta/Horizon Worlds/YOUR_WORLD_ID/scripts'
);
```

## Using in Meta Horizon

### ⚠️ CRITICAL: Script Load Order

**The scripts MUST be loaded in this exact order in Meta Horizon World Editor:**

1. **BloomBeasts-GameEngine-Standalone.ts** (loads first - sets up global namespace)
2. **BloomBeasts-Types.ts**
3. **BloomBeasts-GamePlatform.ts**
4. **BloomBeasts-Game.ts** (loads last - uses the namespace)

If the scripts load in the wrong order, you'll see: `"BloomBeasts namespace not found - check script load order"`

### Setup Steps

1. Run `npm run deploy` to copy files to Meta Horizon
2. In Meta Horizon World Builder, attach the scripts to your world **in the order above**
3. Attach `BloomBeastsUI` component to an entity in your world
4. **Configure Assets**: In the Properties panel, assign all image assets (see [ASSETS.md](./ASSETS.md) for details)
5. The game will initialize automatically when the world loads

### Asset Configuration

The game uses **Props** to load all visual assets. You'll need to:
- Upload your game images to Horizon's asset library
- Assign each image to the corresponding property in the Properties panel
- See [ASSETS.md](./ASSETS.md) for complete asset setup guide

**Required Assets**: 25 image properties including backgrounds, buttons, card templates, icons, and mission backgrounds.

## Architecture

### Game Engine Bundle
**BloomBeasts-GameEngine-Standalone.ts** (469 KB, 112 files)
- Complete game engine wrapped in `BloomBeasts` namespace
- All game logic, card definitions, combat system, missions
- Shared styling constants (COLORS, DIMENSIONS, LAYOUTS, etc.)
- Platform-agnostic core logic

### Horizon Implementation
Three TypeScript files work together:

#### 1. BloomBeasts-GameEngine-Standalone.ts (470 KB)
- Complete game engine in `BloomBeasts` namespace
- 112 files bundled together
- All game logic, cards, missions, combat system
- Shared styling constants

#### 2. BloomBeasts-GamePlatform.ts (7 KB)
`HorizonPlatform` class implementing `BloomBeasts.PlatformCallbacks`:
- **UI Rendering**: Delegates to `BloomBeastsUI` component
- **Asset Loading**: Maps card/background IDs to ImageSource Props
- **Audio Playback**: Plays music and SFX using AudioSource Props
- **Storage**: Multiplayer-aware persistent storage using `world.persistentStorage`
  - Uses `setPlayerVariable()` and `getPlayerVariable()` APIs
  - Automatically isolates data per player
  - Keys prefixed with `bloombeasts_` to avoid conflicts
  - JSON serialization for complex data structures
  - Per-player save data (progress, deck, collection)
- **Input Handling**: Connects game callbacks to UI events

#### 3. BloomBeasts-Game.ts (35 KB)
`BloomBeastsUI` class extending Meta Horizon's `UIComponent`:
- **109 Asset Props**: All images and audio configured in Properties panel
- **Reactive Bindings**: State management using `Binding<T>` for live updates
- **Screen Rendering**: Renders all game screens (menu, missions, cards, battle, settings)
- **Asset Accessors**: Helper methods to retrieve Props by ID
  - `getCardImage(cardId)` - Returns card artwork
  - `getBackground(bgId)` - Returns background image
  - `getAudio(audioId)` - Returns audio source
- **Imports**: References both GameEngine and GamePlatform

## Shared Styles

Both platforms (Web and Horizon) use the same styling constants from the BloomBeasts namespace:

- `BloomBeasts.COLORS` - Color palette
- `BloomBeasts.DIMENSIONS` - Font sizes, spacing, component dimensions
- `BloomBeasts.GAPS` - Gap spacing between elements
- `BloomBeasts.LAYOUTS` - Flexbox layout definitions
- `BloomBeasts.BUTTON_STYLES` - Pre-configured button styles
- `BloomBeasts.TEXT_STYLES` - Pre-configured text styles
- `BloomBeasts.CARD_STYLES` - Pre-configured card styles
- `BloomBeasts.DIALOG_STYLES` - Pre-configured dialog styles

## Multiplayer Storage System

### How It Works

BloomBeasts uses **per-player persistent storage** via Meta Horizon's `world.persistentStorage` API:

```typescript
// Saving data (HorizonPlatform.saveData)
const localPlayer = hz.World.getLocalPlayer();
await world.persistentStorage.setPlayerVariable(
  localPlayer,
  `bloombeasts_${key}`,
  JSON.stringify(data)
);

// Loading data (HorizonPlatform.loadData)
const localPlayer = hz.World.getLocalPlayer();
const serialized = await world.persistentStorage.getPlayerVariable(
  localPlayer,
  `bloombeasts_${key}`
);
const data = JSON.parse(serialized);
```

### Storage Keys

The game saves these keys per player:
- `bloombeasts_gameState` - Overall game progress (level, XP, currency)
- `bloombeasts_collection` - Owned cards and unlock status
- `bloombeasts_deck` - Current deck configuration
- `bloombeasts_missions` - Mission completion status
- `bloombeasts_settings` - Audio and game settings

### Multiplayer Behavior

- **Independent Progress**: Each player has their own save data
- **Session Persistence**: Data survives across sessions and world visits
- **No Conflicts**: Players don't interfere with each other's progress
- **Automatic Save**: Game auto-saves after missions, deck changes, etc.
- **Automatic Load**: Game auto-loads player's save data on world enter

### Storage Format

All data is serialized to JSON strings for storage:
```typescript
{
  playerLevel: 5,
  totalXP: 1200,
  tokens: 500,
  diamonds: 10,
  ownedCards: ['CinderPup', 'Bubblefin', ...],
  deck: ['CinderPup', 'Magmite', ...],
  completedMissions: [1, 2, 3]
}
```

## Development

When making changes to the game engine or shared styles:

1. Edit files in the main `bloombeasts/` or `shared/` directories
2. Run `npm run deploy` to rebuild and deploy
3. Reload your Meta Horizon world to see changes
4. Each player's save data will persist through updates

## Testing Multiplayer

To test the multiplayer storage system:

1. **Single Player Testing**:
   - Play the game, make progress (complete missions, build deck)
   - Exit and re-enter the world
   - Verify your progress is saved

2. **Multi-Player Testing**:
   - Have 2+ players join the same world
   - Each player starts their own game
   - Players progress independently
   - Exit and re-join - each player's progress should persist

3. **Reset Player Data** (for testing):
   - Currently, Meta Horizon doesn't provide UI for clearing player storage
   - Player data persists until manually cleared via scripting
   - You can add a debug command in your world if needed

## Troubleshooting

### File Errors
**"File not found" errors**: Make sure all 3 files are in the same Meta Horizon scripts folder:
- `BloomBeasts-GameEngine-Standalone.ts`
- `BloomBeasts-GamePlatform.ts`
- `BloomBeasts-Game.ts`

Run `npm run deploy` from `deployments/horizon` to copy them automatically.

**Import errors**: The files have dependencies:
- `BloomBeasts-Game.ts` imports from `BloomBeasts-GamePlatform.ts`
- Both reference `BloomBeasts-GameEngine-Standalone.ts`
- All 3 files must be deployed together

**Path issues**: Verify your world ID in `deploy.js` matches your Meta Horizon world folder.

### Type Errors
**Type errors**: Meta Horizon has a limited TypeScript environment. The bundle only uses basic console methods (log, warn, error) for compatibility.

### Storage Issues
**Data not persisting**: Check console for storage errors. Ensure `world.persistentStorage` API is available. Verify that `setPlayerVariable()` and `getPlayerVariable()` methods are working.

**World reference not available**: Make sure the `world` instance is being passed to `HorizonPlatform` constructor in the `initializeGame()` method.

**Conflicts between players**: Each player has isolated storage via `getPlayerVariable(player, key)`. The API automatically handles per-player isolation - each player's data is completely separate.

**JSON parse errors**: Storage data is JSON-serialized. Corrupted data may cause parse errors. Consider adding error handling or data migration logic.

**API not found**: If `persistentStorage` is not available on `world`, check your Meta Horizon version. The API may have changed - consult Meta Horizon documentation for the latest storage APIs.

### Audio Issues
**Audio not playing**: Verify all audio Props are assigned in the Properties panel. Check console for "Audio not found" warnings.

**Volume not working**: Meta Horizon's AudioSource API may have limitations. Check that `play()` and `setVolume()` methods are available.

### Asset Issues
**Images not appearing**: Ensure all 99 image Props are assigned. Missing Props will result in missing UI elements but won't break the game.
